<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Histogram Binning Tutorial · Sunny documentation</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Sunny documentation logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sunny documentation</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Overview</a></li><li><a class="tocitem" href="../../quick-start/">Quick Start</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../fei2_tutorial/">Case Study: FeI<span>$_{2}$</span></a></li><li><a class="tocitem" href="../powder_averaging/">Powder Averaging</a></li><li><a class="tocitem" href="../ising2d/">Classical Ising model</a></li><li class="is-active"><a class="tocitem" href>Histogram Binning Tutorial</a></li></ul></li><li><a class="tocitem" href="../../library/">Library API</a></li><li><a class="tocitem" href="../../structure-factor/">Structure Factor Calculations</a></li><li><a class="tocitem" href="../../versions/">Version History</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Histogram Binning Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Histogram Binning Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/SunnySuite/Sunny.jl/blob/main/examples/binning_tutorial.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Histogram-Binning-Tutorial"><a class="docs-heading-anchor" href="#Histogram-Binning-Tutorial">Histogram Binning Tutorial</a><a id="Histogram-Binning-Tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#Histogram-Binning-Tutorial" title="Permalink"></a></h1><pre><code class="language-julia hljs">using Sunny, GLMakie</code></pre><p>This Tutorial demonstrates how to use Sunny&#39;s histogram binning capabilities (via <a href="../../library/#Sunny.intensities_binned-Tuple{StructureFactor, BinningParameters}"><code>intensities_binned</code></a>). This functionality allows the simulation data produced by Sunny to be compared to experimental data produced by Inelastic Neutron Scattering (INS) in an apples-to-apples fashion. Experimental data can be loaded from a <code>MDHistoWorkspace</code> stored in a <code>.nxs</code> file by the <a href="https://www.mantidproject.org/">Mantid software</a> using <a href="../../library/#Sunny.load_nxs-Tuple{Any}"><code>load_nxs</code></a>.</p><p>For this example, we will examine the CTFD compound, which is crystallographically approximately a square lattice. We specify the crystal lattice structure of CTFD using the lattice parameters specified by</p><p>W Wan et al 2020 J. Phys.: Condens. Matter 32 374007 DOI 10.1088/1361-648X/ab757a</p><pre><code class="language-julia hljs">latvecs = lattice_vectors(8.113,8.119,12.45,90,100,90)
positions = [[0,0,0]]
types = [&quot;Cu&quot;]
formfactors  = [FormFactor(1,&quot;Cu2&quot;)]
xtal = Crystal(latvecs,positions;types);</code></pre><p>We will use a somewhat small periodic lattice size of 6x6x4 in order to showcase the effect of a finite lattice size.</p><pre><code class="language-julia hljs">latsize = (6,6,4);</code></pre><p>In this system, the magnetic lattice is the same as the chemical lattice, and there is a spin-1/2 dipole on each site.</p><pre><code class="language-julia hljs">magxtal = xtal;
valS = 1/2;
sys = System(magxtal, latsize, [SpinInfo(1;S = valS)], :dipole; seed=1);</code></pre><p>Quoted value of J = +6.19(2) meV (antiferromagnetic) between nearest neighbors on the square lattice</p><pre><code class="language-julia hljs">J = 6.19 # meV
characteristic_energy_scale = abs(J * valS)
set_exchange!(sys,J,Bond(1,1,[1,0,0]))
set_exchange!(sys,J,Bond(1,1,[0,1,0]))</code></pre><p>Thermalize the system using the Langevin intergator. The timestep and the temperature are roughly based off the characteristic energy scale of the problem.</p><pre><code class="language-julia hljs">Δt = 0.05 / characteristic_energy_scale
kT = 0.01 * characteristic_energy_scale
langevin = Langevin(Δt; λ=0.1, kT=kT)
randomize_spins!(sys);
for i in 1:10_000 # Long enough to reach equilibrium
    step!(sys, langevin)
end</code></pre><p>The neutron spectrometer used in the experiment had an incident neutron energy of 36.25 meV. Since this is the most amount of energy that can be deposited by the neutron into the sample, we don&#39;t need to consider energies higher than this.</p><pre><code class="language-julia hljs">ωmax = 36.25;</code></pre><p>We choose the resolution in energy (specified by the number of nω modes resolved) to be ≈20× better than the experimental resolution in order to demonstrate the effect of over-resolving in energy.</p><pre><code class="language-julia hljs">nω = 480;
dsf = DynamicStructureFactor(sys; Δt=Δt, nω=nω, ωmax=ωmax, process_trajectory=:symmetrize)</code></pre><pre><code class="nohighlight hljs">StructureFactor (21.075 MiB)
[S(q,ω) | nω = 959 | 1 sample]
Lattice: (6, 6, 4)×1
6 correlations in Dipole mode:
╔ ⬤ ⬤ ⬤ Sx
║ ⋅ ⬤ ⬤ Sy
╚ ⋅ ⋅ ⬤ Sz
</code></pre><p>We re-sample from the thermal equilibrium distribution several times to increase our sample size</p><pre><code class="language-julia hljs">nsamples = 3
for _ in 1:nsamples
    for _ in 1:8000
        step!(sys, langevin)
    end
    add_sample!(dsf, sys)
end</code></pre><p>Since the SU(N)NY crystal has only finitely many lattice sites, there are finitely many ways for a neutron to scatter off of the sample. We can visualize this discreteness by plotting each possible Qx and Qz, for example:</p><pre><code class="language-julia hljs">
# Compute some scattering vectors at and around the first BZ...
scatter!(ax,Qx,Qz)</code></pre><p><img src="../binning_tutorial-22.png" alt/></p><p>One way to display the structure factor is to create a histogram with one bin centered at each discrete scattering possibility using <a href="../../library/#Sunny.unit_resolution_binning_parameters-Tuple{Any, Any, Vararg{Any}}"><code>unit_resolution_binning_parameters</code></a> to create a set of <a href="../../library/#Sunny.BinningParameters"><code>BinningParameters</code></a>.</p><pre><code class="language-julia hljs">params = unit_resolution_binning_parameters(dsf)</code></pre><pre><code class="nohighlight hljs">Binning Parameters
⊡     6 bins from -0.083 to +0.917 along [+1.29 dx] (Δ = 0.129)
⊡     6 bins from -0.083 to +0.917 along [+1.29 dy] (Δ = 0.129)
⊡     4 bins from -0.125 to +0.875 along [-0.34 dx +1.95 dz] (Δ = 0.126)
⊡   480 bins from -0.041 to +38.893 along [+1.00 dE] (Δ = 0.081)
</code></pre><p>Since this is a 4D histogram, it further has to be integrated over two of those directions in order to be displayed. Here, we integrate over Qy and Energy using <a href="../../library/#Sunny.integrate_axes!-Tuple{BinningParameters}"><code>integrate_axes!</code></a>:</p><pre><code class="language-julia hljs">integrate_axes!(params;axes = [2,4]) # Integrate over Qy (2) and E (4)</code></pre><pre><code class="nohighlight hljs">Binning Parameters
⊡     6 bins from -0.083 to +0.917 along [+1.29 dx] (Δ = 0.129)
∫ Integrated from -0.083 to +0.917 along [+1.29 dy] (Δ = 0.774)
⊡     4 bins from -0.125 to +0.875 along [-0.34 dx +1.95 dz] (Δ = 0.126)
∫ Integrated from -0.041 to +38.893 along [+1.00 dE] (Δ = 38.933)
</code></pre><p>Now that we have parameterized the histogram, we can bin our data. In addition to the <a href="../../library/#Sunny.BinningParameters"><code>BinningParameters</code></a>, an <a href="../../library/#Sunny.intensity_formula-Tuple{Function, StructureFactor, Any}"><code>intensity_formula</code></a> needs to be provided to specify which dipole, temperature, and atomic form factor corrections should be applied during the intensity calculation.</p><pre><code class="language-julia hljs">formula = intensity_formula(dsf, :perp; kT, formfactors)
intensity,counts = intensities_binned(dsf, params; formula)
normalized_intensity = intensity ./ counts;</code></pre><p>With the data binned, we can now plot it. The axes labels give the bin centers of each bin, as given by <a href="../../library/#Sunny.axes_bincenters-Tuple{Any, Any, Any}"><code>axes_bincenters</code></a>.</p><pre><code class="language-julia hljs">bin_centers = axes_bincenters(params);

heatmap!(ax,bin_centers[1],bin_centers[3],normalized_intensity[:,1,:,1])
scatter!(ax,Qx,Qz)
xlims!(ax,params.binstart[1],params.binend[1])
ylims!(ax,params.binstart[3],params.binend[3])

</code></pre><p><img src="../binning_tutorial-30.png" alt/></p><p>Note that some bins have no scattering vectors at all when the bin size is made too small:</p><pre><code class="language-julia hljs">params.binwidth[1] /= 1.2
params.binwidth[3] /= 2.5</code></pre><p><img src="../binning_tutorial-32.png" alt/></p><p>Conversely, making the bins bigger doesn&#39;t break anything, but loses resolution:</p><pre><code class="language-julia hljs">params.binwidth[1] *= 2
params.binwidth[3] *= 2</code></pre><p><img src="../binning_tutorial-34.png" alt/></p><p>Recall that while we under-resolved in Q by choosing a small lattice, we over-resolved in energy:</p><pre><code class="language-julia hljs">scatter!(ax,x,y)</code></pre><pre><code class="nohighlight hljs">MakieCore.Scatter{Tuple{Vector{GeometryBasics.Point{2, Float32}}}}</code></pre><p>Let&#39;s make a new histogram which includes the energy axis. The x-axis of the histogram will be a 1D cut from <code>Q = [0,0,0]</code> to <code>Q = [1,1,0]</code>. See <a href="../../library/#Sunny.slice_2D_binning_parameters-Tuple{Vector{Float64}, Any, Any, Int64, Any}"><code>slice_2D_binning_parameters</code></a>.</p><pre><code class="language-julia hljs">x_axis_bin_count = 10
cut_width = 0.3
params = slice_2D_binning_parameters(dsf,[0,0,0],[1,1,0],x_axis_bin_count,cut_width)</code></pre><pre><code class="nohighlight hljs">Binning Parameters
⊡    10 bins from +0.000 to +1.414 along [+0.91 dx +0.91 dy] (Δ = 0.109)
∫ Integrated from -0.150 to +0.150 along [-0.91 dx +0.91 dy] (Δ = 0.232)
∫ Integrated from -0.150 to +0.150 along [+0.34 dx -1.95 dz] (Δ = 0.151)
⊡   480 bins from -0.041 to +38.893 along [+1.00 dE] (Δ = 0.081)
</code></pre><p>There are no longer any scattering vectors exactly in the plane of the cut. Instead, as described in the <code>BinningParameters</code> output above, the transverse Q directions are integrated over, so slightly out of plane points are included.</p><p>We plot the intensity on a log-scale to improve visibility.</p><pre><code class="language-julia hljs">intensity,counts = intensities_binned(dsf, params; formula)
log_intensity = log10.(intensity ./ counts);
heatmap!(ax,bin_centers[1],bin_centers[4],log_intensity[:,1,1,:])</code></pre><p><img src="../binning_tutorial-40.png" alt/></p><p>By reducing the number of energy bins to be closer to the number of bins on the x-axis, we can make the dispersion curve look nicer:</p><pre><code class="language-julia hljs">params.binwidth[4] *= 20
heatmap!(ax,bin_centers[1],bin_centers[4],log_intensity[:,1,1,:])</code></pre><p><img src="../binning_tutorial-42.png" alt/></p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../ising2d/">« Classical Ising model</a><a class="docs-footer-nextpage" href="../../library/">Library API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Monday 17 July 2023 21:58">Monday 17 July 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
